<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Yeni Şifre Belirle - PCPartsBuild</title>
    <link rel="icon" type="image/ico" href="Assets/Images/favicon.ico">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="./styles.css">
</head>

<body class="bg-background-dark font-display text-gray-300 transition-default overflow-hidden">
    <video autoplay="" id="bg-video" loop="" muted="" playsinline="">
        <source src="Assets/Videos/Video1.webm" type="video/webm"/>
    </video>

    <a class="absolute top-4 left-4 z-20 w-12 h-12 rounded-full bg-black/30 backdrop-blur-md border border-white/20 flex items-center justify-center text-white hover:bg-black/50 transition-colors" href="anasayfa.html">
        <span class="material-symbols-outlined text-xl"> home </span>
    </a>

    <div class="relative min-h-screen flex items-center justify-center p-4 lg:p-8">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md p-6 sm:p-8 bg-gray-900/90 rounded-lg shadow-2xl">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-white">Şifre Sıfırlama</h1>
                <p class="text-gray-400 mt-1" id="headerText">Hesabınıza bağlı e-posta adresini girin.</p>
            </header>
            <main>
                <form id="emailForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1" for="email">Email</label>
                        <input class="w-full bg-gray-800 border-gray-700 rounded-md focus:ring-primary focus:border-primary text-white placeholder:text-gray-500 transition-default" 
                               id="email" name="email" placeholder="Email" type="email" required/>
                    </div>
                    <button id="sendCodeBtn" class="w-full bg-primary text-white font-semibold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 mt-2 hover:bg-primary/90 transition-colors" type="submit">
                        Doğrulama Kodu Gönder
                    </button>
                </form>

                <form id="codeForm" class="space-y-4 hidden-step">
                    <div class="text-center mb-4">
                        <span class="text-sm text-gray-400">Kod şuraya gönderildi: <span id="displayEmail" class="text-white font-medium"></span></span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1" for="code">Doğrulama Kodu</label>
                        <input class="w-full bg-gray-800 border-gray-700 rounded-md focus:ring-primary focus:border-primary text-white text-center text-2xl tracking-widest placeholder:text-gray-600 transition-default" 
                               id="code" name="code" placeholder="******" type="text" maxlength="6" required/>
                    </div>
                    <button id="verifyBtn" class="w-full bg-primary text-white font-semibold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 mt-2 hover:bg-primary/90 transition-colors" type="submit">
                        Kodu Doğrula
                    </button>
                    
                    <button type="button" id="backBtn" class="w-full text-sm text-gray-500 hover:text-gray-300 mt-2 text-center block">
                        E-posta adresini değiştir
                    </button>
                </form>
            </main>
        </div>
    </div>

    <script>
        // API Adresini buraya yaz (Localhost ise ona göre ayarla, canlı ise domaini yaz)
        const BASE_URL = "https://pcpartsbuild.com/api/auth";

        const emailForm = document.getElementById('emailForm');
        const codeForm = document.getElementById('codeForm');
        const emailInput = document.getElementById('email');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const backBtn = document.getElementById('backBtn');

        // --- ADIM 1: MAİL GÖNDER ---
        emailForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = emailInput.value;
            
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = 'Gönderiliyor...';

            try {
                const response = await fetch(`${BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                if (response.ok) {
                    // Arayüzü değiştir (Mail formu gizle, Kod formu aç)
                    emailForm.classList.add('hidden-step');
                    codeForm.classList.remove('hidden-step');
                    document.getElementById('displayEmail').textContent = email;
                    document.getElementById('headerText').textContent = 'Mailinize gelen 6 haneli kodu girin.';
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Kod Gönderildi',
                        text: 'Lütfen mail kutunuzu kontrol edin.',
                        background: '#1f2937', color: '#fff', confirmButtonColor: '#16a3b2'
                    });
                } else {
                    Swal.fire({ icon: 'error', title: 'Hata', text: 'Kod gönderilemedi.', background: '#1f2937', color: '#fff' });
                }
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Sunucuya ulaşılamadı.', background: '#1f2937', color: '#fff' });
            } finally {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = 'Doğrulama Kodu Gönder';
            }
        });

        // --- ADIM 2: KODU DOĞRULA ---
        codeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('code').value;
            const email = emailInput.value;

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Kontrol Ediliyor...';

            try {
                const response = await fetch(`${BASE_URL}/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, code: code })
                });

                const result = await response.json();

                if (response.ok && result.token) {
                    // Kod doğru! Token alındı. 
                    // Kullanıcıyı yeni şifre belirleme sayfasına yönlendir.
                    // Token ve maili URL ile taşıyoruz.
                    const targetUrl = `sifre-sifirla.html?email=${encodeURIComponent(email)}&token=${encodeURIComponent(result.token)}`;
                    window.location.href = targetUrl;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hatalı Kod',
                        text: result.message || 'Girdiğiniz kod yanlış.',
                        background: '#1f2937', color: '#fff', confirmButtonColor: '#d33'
                    });
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Sunucu hatası.', background: '#1f2937', color: '#fff' });
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Kodu Doğrula';
            }
        });

        // Geri Dön Butonu
        backBtn.addEventListener('click', function() {
            codeForm.classList.add('hidden-step');
            emailForm.classList.remove('hidden-step');
            document.getElementById('headerText').textContent = 'Hesabınıza bağlı e-posta adresini girin.';
        });
    </script>
</body>
</html>