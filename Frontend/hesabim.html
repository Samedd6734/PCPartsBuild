<!DOCTYPE html>
<html class="dark" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title data-i18n="page-title">PCPartsBuild - Hesabım</title>
    <link rel="icon" type="image/ico" href="Assets/Images/favicon.ico">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<script>
    (function() {
        // Tüm sayfalarda ortak anahtar: 'theme_builder'
        const savedTheme = localStorage.getItem('theme_builder');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    })();
</script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="./styles.css">
</head>
<body class="bg-gray-100 dark:bg-[#0d1117] font-sans text-gray-900 dark:text-white antialiased selection:bg-primary selection:text-white hidden">
    <div class="relative flex min-h-screen flex-col">
        
        <header class="w-full px-4 md:px-8 py-4 border-b border-gray-200 dark:border-gray-800/50 bg-white dark:bg-background-dark transition-colors duration-300">
            <nav class="container mx-auto flex justify-between items-center">
                <a class="flex items-center gap-2 text-xl font-bold text-gray-900 dark:text-white" href="anasayfa.html">
                    <img src="Assets/Images/logo.webp" alt="PCPartsBuild" class="h-10 md:h-14">
                </a>
        
                <nav class="hidden lg:flex items-center gap-9">
                    <a class="text-gray-600 dark:text-white/80 text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" href="pts.html" data-i18n="nav-wizard">PC Toplama Sihirbazı</a>
                    <a class="text-gray-600 dark:text-white/80 text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" href="puk.html" data-i18n="nav-compatibility">Parça Uyumluluk Kontrolü</a>
                    <a class="text-gray-600 dark:text-white/80 text-sm font-medium hover:text-primary dark:hover:text-white transition-colors" href="pbg.html" data-i18n="nav-info">PC Bileşenleri</a>
                </nav>

                <div class="flex items-center gap-3">
                    <div id="languageSelector" class="relative">
                        <button id="languageButton" class="flex cursor-pointer items-center justify-center rounded-lg h-10 w-10 bg-gray-100 border border-gray-200 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:bg-gray-700 transition-colors">
                            <span class="material-symbols-outlined text-xl">language</span>
                        </button>
                        <div id="languageDropdown" class="absolute right-0 top-full mt-2 w-32 bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden z-20 hidden dark:bg-gray-800 dark:border-gray-700">
                            <a href="#" data-lang="tr" class="language-option block px-4 py-2 text-sm text-gray-700 hover:bg-primary hover:text-white dark:text-gray-200 transition-colors">Türkçe (TR)</a>
                            <a href="#" data-lang="en" class="language-option block px-4 py-2 text-sm text-gray-700 hover:bg-primary hover:text-white dark:text-gray-200 transition-colors">English (EN)</a>
                        </div>
                    </div>
        
                    <button id="darkModeButton" class="relative flex items-center justify-center h-10 w-10 rounded-lg bg-gray-100 border border-gray-200 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:bg-gray-700 transition-colors overflow-hidden">
                        <span id="moonIcon" class="material-symbols-outlined absolute icon-transition opacity-0 scale-50 rotate-90 dark:opacity-100 dark:scale-100 dark:rotate-0">dark_mode</span>
                        <span id="sunIcon" class="material-symbols-outlined absolute icon-transition opacity-100 scale-100 rotate-0 dark:opacity-0 dark:scale-50 dark:-rotate-90">light_mode</span>
                    </button>
                </div>
            </nav>
        </header>

        <main class="flex-1 py-10 px-4 sm:px-6 lg:px-8">
            <div class="mx-auto max-w-[92%] w-full">
                
                <div class="mb-8 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white" data-i18n="page-header">Hesap Ayarları</h1>
                        <p class="text-gray-500 dark:text-white/60 mt-1" data-i18n="page-subtext">Profil bilgilerinizi ve kayıtlı sistemlerinizi yönetin.</p>
                    </div>
                    <button id="logout-btn-main" class="mt-4 md:mt-0 inline-flex items-center justify-center gap-2 rounded-lg bg-red-100 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-200 dark:bg-red-500/10 dark:text-red-500 dark:hover:bg-red-500/20 transition-colors ring-1 ring-inset ring-red-500/20">
                        <span class="material-icons-outlined text-lg">logout</span>
                        <span data-i18n="auth-logout">Çıkış Yap</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-16 lg:grid-cols-12">
                    
                    <aside class="lg:col-span-3 xl:col-span-2 w-full max-w-[280px]">
                        <div class="sticky top-24 space-y-4">
                            
                            <div class="glass-panel rounded-2xl p-6 flex flex-col items-center text-center bg-white dark:bg-transparent border border-gray-200 dark:border-white/5 shadow-sm dark:shadow-none">
                                <div class="relative mb-4">
                                    <img id="profile-img" src="" class="h-24 w-24 rounded-full border-4 border-gray-100 dark:border-[#0f171c] shadow-lg">
                                </div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white" id="display-fullname">...</h2>
                                <div class="mt-4 inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-700 dark:bg-green-500/10 dark:text-green-400 ring-1 ring-inset ring-green-600/20">
                                    <span data-i18n="status-active">Aktif Üye</span>
                                </div>
                            </div>

                            <nav class="glass-panel rounded-xl overflow-hidden p-2 bg-white dark:bg-transparent border border-gray-200 dark:border-white/5 shadow-sm dark:shadow-none">
                                <a href="#" class="flex items-center gap-3 rounded-lg bg-primary/10 px-4 py-3 text-sm font-medium text-primary transition-colors">
                                    <span class="material-icons-round">person</span>
                                    <span data-i18n="menu-profile">Profil Bilgileri</span>
                                </a>
                                <a href="kayitli_sistemler.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-sm font-medium text-gray-600 dark:text-white/70 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white transition-colors">
                                    <span class="material-icons-round">computer</span>
                                    <span data-i18n="menu-systems">Kayıtlı Sistemlerim</span>
                                </a>
                                <a href="favorilerim.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-sm font-medium text-gray-600 dark:text-white/70 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white transition-colors">
                                    <span class="material-icons-round">shopping_bag</span>
                                    <span data-i18n="menu-favorites">Favoriler</span>
                                </a>
                                <a href="sifre-degistir.html" class="flex items-center gap-3 rounded-lg px-4 py-3 text-sm font-medium text-gray-600 dark:text-white/70 hover:bg-gray-100 dark:hover:bg-white/5 hover:text-gray-900 dark:hover:text-white transition-colors">
                                    <span class="material-icons-round">lock</span>
                                    <span data-i18n="menu-password">Şifre Değiştir</span>
                                </a>
                            </nav>
                        </div>
                    </aside>

                    <div class="lg:col-span-9 xl:col-span-10 space-y-6">
                        
                        <div class="glass-panel rounded-2xl p-6 sm:p-8 bg-white dark:bg-[#111c22] border border-gray-200 dark:border-white/5 shadow-sm dark:shadow-none transition-colors duration-300">
                            <div class="mb-8 flex items-center justify-between border-b border-gray-200 dark:border-white/10 pb-6">
                               <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">person</span>
                                    <span data-i18n="form-title">Kişisel Bilgiler</span>
                                </h3>
                                <button id="btn-edit-toggle" class="text-sm font-medium text-primary hover:text-cyan-500 transition-colors" data-i18n="btn-edit">Düzenle</button>
                            </div>
                            
                            <form id="profile-form" class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-500 dark:text-white/60 uppercase tracking-wider" data-i18n="label-fullname">Ad Soyad</label>
                                    <input type="text" id="input-fullname" class="w-full rounded-lg bg-gray-50 dark:bg-black/20 border border-gray-300 dark:border-white/10 px-4 py-3 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-white/30 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all" disabled>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-500 dark:text-white/60 uppercase tracking-wider" data-i18n="label-username">Kullanıcı Adı</label>
                                    <input type="text" id="input-username" class="w-full rounded-lg bg-gray-50 dark:bg-black/20 border border-gray-300 dark:border-white/10 px-4 py-3 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-white/30 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all" disabled>
                                    </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-500 dark:text-white/60 uppercase tracking-wider" data-i18n="label-email">E-Posta</label>
                                    <input type="email" id="input-email" class="w-full rounded-lg bg-gray-50 dark:bg-black/20 border border-gray-300 dark:border-white/10 px-4 py-3 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-white/30 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all" disabled>
                                    </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-gray-500 dark:text-white/60 uppercase tracking-wider" data-i18n="label-phone">Telefon</label>
                                    <input type="tel" id="input-phone" class="w-full rounded-lg bg-gray-50 dark:bg-black/20 border border-gray-300 dark:border-white/10 px-4 py-3 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-white/30 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all" disabled>
                                </div>
                                
                                <div class="sm:col-span-2 flex justify-end pt-4">
                                    <button id="btn-save-changes" type="button" disabled class="rounded-lg bg-primary px-6 py-2.5 text-sm font-bold text-white shadow-lg shadow-primary/20 hover:brightness-110 hover:scale-[1.02] active:scale-95 transition-all opacity-50 cursor-not-allowed" data-i18n="btn-save">
                                        Değişiklikleri Kaydet
                                    </button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-auto border-t border-gray-200 dark:border-white/10 bg-gray-100 dark:bg-[#0d1317] py-8 text-center transition-colors duration-300">
            <p class="text-white/60 text-sm font-normal leading-normal">
                <span data-i18n="footer-copyright">© 2025 PCPartsBuild. Tüm Hakları Saklıdır. Bize Ulaşın:</span> <a class="underline hover:text-primary" href="mailto:pcpartsbuild@gmail.com">pcpartsbuild@gmail.com</a>
            </p>
        </footer>

    </div>

    <script>
        // --- 1. GÜVENLİK VE VERİ ÇEKME KODLARI ---
        
        // Sayfa yüklenirken ilk iş: Kullanıcı giriş yapmış mı?
        // Bu kod, login olduğunda localStorage'a kaydettiğimiz 'userId' değerine bakar.
        const userId = localStorage.getItem('userId');
        
        if (!userId) {
            // Giriş yapılmamış! Hemen ana sayfaya veya girişe postala.
            window.location.href = 'giris.html';
        } else {
            // Giriş yapılmış, sayfayı görünür yap.
            document.body.classList.remove('hidden');

            // --- Bu sayfaya link ile mi gelindi kontrolü ---
            const urlParams = new URLSearchParams(window.location.search);
            const emailToken = urlParams.get('emailToken');

            if (emailToken) {
                // Linkten gelinmiş, onaya gönder
                confirmEmailChange(emailToken);
            } else {
                // Normal giriş, verileri çek
                fetchUserData(userId);
            }
        }

// --- E-POSTA ONAYLA FONKSİYONU (DÜZELTİLMİŞ HALİ) ---
    async function confirmEmailChange(token) {
        Swal.fire({
            title: 'İşleniyor...',
            text: 'E-posta değişikliğiniz onaylanıyor, lütfen bekleyin.',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); },
            background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
            color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
        });

        try {
            const response = await fetch('https://pcpartsbuild.com/api/auth/confirm-email-change', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: token })
            });

            const result = await response.json();

            if (response.ok) {
                Swal.fire({
                    title: 'Başarılı!',
                    text: 'E-posta adresiniz başarıyla güncellendi!',
                    icon: 'success',
                    background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000',
                    confirmButtonColor: '#16a3b2'
                }).then(() => {
                    // Token'ı URL'den temizle
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Güncel verileri çek
                    fetchUserData(localStorage.getItem('userId'));
                });
            } else {
                Swal.fire({
                    title: 'Hata',
                    text: result.Message || 'Onay işlemi başarısız.',
                    icon: 'error',
                    background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
                });
            }
        } catch (error) {
            console.error('Hata:', error);
            Swal.fire({ title: 'Hata', text: 'Sunucuya bağlanılamadı.', icon: 'error' });
        }
    }

        async function fetchUserData(id) {
            try {
                // Backend'deki yeni yazdığımız metoda istek atıyoruz
                const response = await fetch(`https://pcpartsbuild.com/api/auth/get-user/${id}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Gelen verileri kutucuklara doldur
                    document.getElementById('input-fullname').value = data.fullName || ''; // Boşsa hata vermesin
                    document.getElementById('input-username').value = data.username;
                    document.getElementById('input-email').value = data.email;
                    document.getElementById('input-phone').value = data.phoneNumber || '';

                    // Soldaki profil kartını güncelle
                    document.getElementById('display-fullname').innerText = data.fullName || data.username;
                    
                    // Profil resmini güncelle (UI Avatars)
                    const imgName = data.fullName ? data.fullName : data.username;
                    document.getElementById('profile-img').src = `https://ui-avatars.com/api/?name=${imgName}&background=16a3b2&color=fff&size=128`;

                } else {
                    console.error("Kullanıcı verisi alınamadı.");
                }
            } catch (error) {
                console.error("Sunucu hatası:", error);
            }
        }

        // --- 2. ÇEVİRİ VE TEMA KODLARI (Aynen Korundu) ---
        const translations = {
            tr: {
                "page-title": "PCPartsBuild - Hesabım",
                "nav-wizard": "PC Toplama Sihirbazı",
                "nav-compatibility": "Parça Uyumluluk Kontrolü",
                "nav-info": "PC Bileşenleri",
                "auth-logout": "Çıkış Yap",
                "page-header": "Hesap Ayarları",
                "page-subtext": "Profil bilgilerinizi ve kayıtlı sistemlerinizi yönetin.",
                "status-active": "Aktif Üye",
                "menu-profile": "Profil Bilgileri",
                "menu-systems": "Kayıtlı Sistemlerim",
                "menu-favorites": "Favoriler",
                "menu-password": "Şifre Değiştir",
                "form-title": "Kişisel Bilgiler",
                "btn-edit": "Düzenle",
                "label-fullname": "Ad Soyad",
                "label-username": "Kullanıcı Adı",
                "label-email": "E-Posta",
                "label-phone": "Telefon",
                "btn-save": "Değişiklikleri Kaydet",
                "footer-copyright": "© 2025 PCPartsBuild. Tüm Hakları Saklıdır. Bize Ulaşın:"
            },
            en: {
                "page-title": "PCPartsBuild - My Account",
                "nav-wizard": "PC Builder Wizard",
                "nav-compatibility": "Compatibility Check",
                "nav-info": "PC Components",
                "auth-logout": "Log Out",
                "page-header": "Account Settings",
                "page-subtext": "Manage your profile information and saved builds.",
                "status-active": "Active Member",
                "menu-profile": "Profile Info",
                "menu-systems": "My Saved Builds",
                "menu-favorites": "Favorites",
                "menu-password": "Change Password",
                "form-title": "Personal Information",
                "btn-edit": "Edit",
                "label-fullname": "Full Name",
                "label-username": "Username",
                "label-email": "Email",
                "label-phone": "Phone",
                "btn-save": "Save Changes",
                "footer-copyright": "© 2025 PCPartsBuild. All Rights Reserved. Contact Us:"
            }
        };

        function setLanguage(lang) {
    if (!translations[lang]) lang = 'tr';
    
    // Dili hafızaya kaydet
    localStorage.setItem('lang', lang);
    document.documentElement.lang = lang;
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = translations[lang][key];
            else el.textContent = translations[lang][key];
        }
    });
}

    // Tema Değiştirme Fonksiyonu
    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');

        if (isDark) {
            html.classList.remove('dark');
            localStorage.setItem('theme_builder', 'light'); // Ortak anahtar
        } else {
            html.classList.add('dark');
            localStorage.setItem('theme_builder', 'dark'); // Ortak anahtar
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Dil Ayarını Yükle
        const savedLang = localStorage.getItem('lang') || 'tr';
        setLanguage(savedLang);

        // 2. Tema Butonu
        const darkModeBtn = document.getElementById('darkModeButton');
        if (darkModeBtn) {
            darkModeBtn.addEventListener('click', toggleTheme);
        }

        // 3. Dil Seçenekleri
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                const selectedLang = e.target.getAttribute('data-lang');
                setLanguage(selectedLang);
                document.getElementById('languageDropdown').classList.add('hidden');
            });
        });

            // Dropdownlar ve Butonlar
            const dropdowns = { 'languageButton': 'languageDropdown' };
            Object.keys(dropdowns).forEach(btnId => {
                const btn = document.getElementById(btnId);
                const menu = document.getElementById(dropdowns[btnId]);
                if(btn && menu) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        menu.classList.toggle('hidden');
                    });
                }
            });
            document.addEventListener('click', () => {
                Object.values(dropdowns).forEach(id => document.getElementById(id).classList.add('hidden'));
            });

            // Dil Değiştirme
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    setLanguage(e.target.getAttribute('data-lang'));
                    document.getElementById('languageDropdown').classList.add('hidden');
                });
            });

            // Çıkış Yap
        const logoutBtn = document.getElementById('logout-btn-main');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'Çıkış',
                    text: 'Emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Evet',
                    cancelButtonText: 'İptal',
                    background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000'
                }).then((r) => {
                    if (r.isConfirmed) {
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('userId');
                        window.location.href = 'anasayfa.html';
                    }
                });
            });
        }
            document.getElementById('logout-btn-main')?.addEventListener('click', logoutAction);

// --- 3. DÜZENLEME VE KAYDETME MANTIĞI ---

const editBtn = document.getElementById('btn-edit-toggle');
const saveBtn = document.getElementById('btn-save-changes');

// Inputları Tanımla
const inputFullname = document.getElementById('input-fullname');
const inputPhone = document.getElementById('input-phone');
// EKLENENLER:
const inputUsername = document.getElementById('input-username');
const inputEmail = document.getElementById('input-email');

// --- YENİ EKLENEN DEĞİŞKEN: ESKİ VERİLERİ TUTACAK ---
let originalValues = {}; 

// Düzenle Butonuna Tıklanınca
editBtn.addEventListener('click', () => {
    // Kilidi Aç / Kapat (Toggle)
    const isLocked = inputFullname.disabled;

    if (isLocked) {
        // --- 1. DÜZENLEME BAŞLADI: MEVCUT VERİLERİ YEDEKLE ---
        originalValues = {
            fullname: inputFullname.value,
            username: inputUsername.value,
            email: inputEmail.value,
            phone: inputPhone.value
        };

        // Düzenleme Modunu AÇ (Kilitleri Kaldır)
        inputFullname.disabled = false;
        inputPhone.disabled = false;
        inputUsername.disabled = false;
        inputEmail.disabled = false;
        
        // Kaydet butonunu aktif et
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        
        // Buton görünümünü değiştir
        editBtn.innerText = "İptal";
        editBtn.classList.replace('text-primary', 'text-red-500');

    } else {
        // --- 2. İPTAL EDİLDİ: YEDEKTEN GERİ YÜKLE ---
        inputFullname.value = originalValues.fullname;
        inputUsername.value = originalValues.username;
        inputEmail.value = originalValues.email;
        inputPhone.value = originalValues.phone;

        // Düzenleme Modunu KAPAT (Tekrar Kilitle)
        inputFullname.disabled = true;
        inputPhone.disabled = true;
        inputUsername.disabled = true;
        inputEmail.disabled = true;
        
        // Kaydet butonunu pasif et
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');

        // Buton görünümünü eski haline getir
        editBtn.innerText = "Düzenle"; 
        editBtn.classList.replace('text-red-500', 'text-primary');
    }
});

// Kaydet Butonuna Tıklanınca
saveBtn.addEventListener('click', async () => {
    saveBtn.innerText = "Kaydediliyor...";
    saveBtn.disabled = true;

    const updateData = {
        userId: localStorage.getItem('userId'),
        fullName: inputFullname.value,
        phoneNumber: inputPhone.value,
        username: inputUsername.value, // inputUsername değişkeninden alıyoruz
        email: inputEmail.value        // inputEmail değişkeninden alıyoruz
    };

    try {
        const response = await fetch('https://pcpartsbuild.com/api/auth/update-profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        const resultData = await response.json(); // Hata mesajını okumak için

        if (response.ok) {
            // --- BURASI DÜZELTİLDİ: ARTIK E-POSTA ONAYINI KONTROL EDİYOR ---
            
            // Backend'den gelen cevaba göre uyarı veya başarı mesajı göster
            if (resultData.emailPending || resultData.EmailPending) {
                Swal.fire({
                    title: 'Onay Gerekli',
                    html: `Profil bilgileriniz güncellendi.<br><br><b>Ancak e-posta değişikliği için</b> mevcut adresinize gönderilen doğrulama linkine tıklamanız gerekmektedir.`,
                    icon: 'info',
                    background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000',
                    confirmButtonColor: '#16a3b2',
                    confirmButtonText: 'Tamam'
                });
            } else {
                // Sadece isim/telefon değiştiyse normal başarı mesajı
                Swal.fire({
                    title: 'Başarılı!',
                    text: 'Profil bilgileriniz güncellendi.',
                    icon: 'success',
                    background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                    color: document.documentElement.classList.contains('dark') ? '#fff' : '#000',
                    confirmButtonColor: '#16a3b2'
                });
            }

            // Ekranı güncelle ve kilitle
            document.getElementById('display-fullname').innerText = updateData.fullName || updateData.username;
            
            inputFullname.disabled = true;
            inputPhone.disabled = true;
            inputUsername.disabled = true;
            inputEmail.disabled = true;

            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
            editBtn.innerText = "Düzenle";
            editBtn.classList.replace('text-red-500', 'text-primary');

        } else {
            // Backend'den gelen hatayı yakala
            let errorMessage = "Güncelleme sırasında bir hata oluştu.";

            // 1. Durum: Bizim gönderdiğimiz özel "Message" alanı varsa (Örn: "Bu email kullanımda")
            if (resultData.Message) {
                errorMessage = resultData.Message;
            }
            // 2. Durum: Identity'den gelen liste şeklindeki hatalar varsa
            else if (Array.isArray(resultData)) {
                errorMessage = resultData.map(err => err.description).join('<br>');
            }
            // 3. Durum: Küçük harfli "message" gelirse (Bazı framework durumları için yedek)
            else if (resultData.message) {
                errorMessage = resultData.message;
            }

            // Hata mesajını kullanıcıya göster
            Swal.fire({
                title: 'Güncelleme Başarısız',
                html: errorMessage, // 'html' özelliği sayesinde alt alta yazılan hataları destekler
                icon: 'error',
                background: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff',
                color: document.documentElement.classList.contains('dark') ? '#fff' : '#000',
                confirmButtonColor: '#d33'
            });
        }
    } catch (error) {
        console.error('Hata:', error);
        Swal.fire({
            title: 'Sunucu Hatası',
            text: 'Sunucuya bağlanılamadı.',
            icon: 'error'
        });
    } finally {
        saveBtn.innerText = "Değişiklikleri Kaydet";
        // Eğer hata varsa ve düzeltme şansı vereceksek butonu tekrar aktif bırakabilirsin,
        // ama şimdilik UX gereği kilitliyoruz ki kullanıcı tekrar "Düzenle" desin veya hatayı görsün.
        if(!inputFullname.disabled) {
             saveBtn.disabled = false; // Hata aldıysa buton aktif kalsın
        }
    }
});
        });
    </script>
</body>
</html>